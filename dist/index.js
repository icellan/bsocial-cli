#!/usr/bin/env node
import fs from"fs";import Yargs from"yargs";import{hideBin}from"yargs/helpers";import Configstore from"configstore";import qrcode from"qrcode-terminal";import{newProfile}from"./new.js";import{askAction,askProfile}from"./inquirer.js";import{post}from"./post.js";import{importProfile}from"./import.js";import{getBalance,getKeys}from"./bitcoin.js";export const DEBUG=!1;export const APP_NAME="bsocial.cli";const conf=new Configstore("bsocial-cli"),options=Yargs(hideBin(process.argv)).usage("Usage: -p <profile file>").option("p",{alias:"profile",describe:"Profile to use",type:"string"}).option("m",{alias:"message",describe:"Message to send on-chain",type:"string"}).argv;options.location&&(console.log("Config stored at:",conf.path),process.exit(0));let fsMessage;try{fsMessage=fs.readFileSync(process.stdin.fd).toString()}catch(a){}function loadSats(a){const{address:b}=getKeys(a);qrcode.generate("bitcoin:"+b,function(a){console.log(a)}),console.log(`\nAddress: ${b}\n`)}const run=async()=>{let a=options.profile;if(!a){const b=await askProfile(conf);a="+ import"===b.profile?await importProfile(conf):"+ new"===b.profile?await newProfile(conf):b.profile}a||(console.error("No profile selected"),process.exit(-1));const b=conf.get(a);b&&b.xpriv&&b.ids||(console.error("Profile is not valid"),process.exit(-1));const c=await getBalance(b);if(0>=c?(console.log("Address does not have any satoshis. Please fund this address to post from this program.\n"),loadSats(b),process.exit(-1)):console.log("Current wallet balance:",c),fsMessage)await post(b,fsMessage.trim());else if(options.message)await post(b,options.message);else for(;;){const a=await askAction(conf);"post"===a.action?await post(b,""):"load sats"===a.action?loadSats(b):"exit"===a.action&&process.exit(0)}};run();