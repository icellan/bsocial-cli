import _BSocial from"bsocial";import{BAP}from"bitcoin-bap";import bsv from"bsv";import fetch from"node-fetch";const BSocial=_BSocial.default;import{askMessage}from"./inquirer.js";import{getUtxos,getTx,getKeys}from"./bitcoin.js";import{DEBUG}from"./index.js";const appName="bsocial.cli";export const post=async function(a,b){if(!b){const a=await askMessage();b=a?.message}b||(console.error("No message to post"),process.exit(-1));const c=new BSocial(appName),d=c.post();d.addText(b);const e=d.getOps(),f=new BAP(a.xpriv);f.importIds(a.ids);const g=f.listIds(),h=f.getId(g[0]),{privateKey:i,address:j}=getKeys(a),k=await getUtxos(a),l=[];for(let c=0;c<k.length;c++){const a=k[c],b=await getTx(a.tx_hash),d=new bsv.Transaction;d.fromString(b);const e=d.outputs[a.tx_pos].toObject();l.push({txid:a.tx_hash,vout:+a.tx_pos,satoshis:+e.satoshis,scriptPubKey:e.script})}const m=h.signOpReturnWithAIP(e),n=m.map(a=>Buffer.from(a,"hex")),o=new bsv.Transaction;if(o.from(l),o.change(j),o.addSafeData(n),o.sign(i),DEBUG)return void console.log(JSON.stringify(o.toObject(),null,4),o.toString());const p=await fetch("https://api.whatsonchain.com/v1/bsv/main/tx/raw",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({txhex:o.toString()})});200===p.status?console.log("Posted transaction to the blockchain:",o.id):console.error("Error posting to the chain:",p.status,p.statusText)};